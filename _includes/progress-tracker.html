<script>
(function() {
  const STORAGE_KEY = 'bootcamp2025_progress';
  const LAST_PAGE_KEY = 'bootcamp2025_lastpage';

  // Get current page path
  const currentPath = window.location.pathname;
  const isHomePage = currentPath === '/' || currentPath.endsWith('/index.html') || currentPath === '/index.html' || currentPath.match(/^\/[^\/]*\/?$/);

  // Auto-redirect to last page if on homepage
  function autoResume() {
    const lastPage = localStorage.getItem(LAST_PAGE_KEY);
    if (lastPage && isHomePage) {
      const data = JSON.parse(lastPage);
      // Only redirect if the last page wasn't the homepage
      if (data.path && !data.path.endsWith('/index.html') && data.path !== '/' && data.path !== '/index.html') {
        window.location.href = data.path;
      }
    }
  }

  // Save current page as last visited (except homepage)
  if (!isHomePage) {
    const pageTitle = document.title.replace(' - ML Protein Design Bootcamp 2025', '');
    localStorage.setItem(LAST_PAGE_KEY, JSON.stringify({
      path: currentPath,
      title: pageTitle,
      timestamp: Date.now()
    }));
  }

  // Load progress data
  function getProgress() {
    const data = localStorage.getItem(STORAGE_KEY);
    return data ? JSON.parse(data) : { completed: [] };
  }

  // Save progress data
  function saveProgress(progress) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
  }

  // Update progress bar on homepage
  function updateProgressBar() {
    const progress = getProgress();
    const totalModules = document.querySelectorAll('.module-checkbox').length ||
                         parseInt(document.body.dataset.totalModules) || 8; // fallback
    const completed = progress.completed.length;
    const percent = Math.round((completed / totalModules) * 100);

    const bar = document.getElementById('progress-bar');
    const count = document.getElementById('completed-count');

    if (bar) {
      bar.style.width = percent + '%';
      bar.textContent = percent + '%';
      bar.setAttribute('aria-valuenow', percent);
    }
    if (count) {
      count.textContent = completed;
    }
  }

  // Initialize checkboxes on module pages
  function initCheckboxes() {
    const checkboxes = document.querySelectorAll('.module-checkbox');
    const progress = getProgress();

    checkboxes.forEach(cb => {
      const id = cb.dataset.moduleId;

      // Restore state
      if (progress.completed.includes(id)) {
        cb.checked = true;
      }

      // Save on change
      cb.addEventListener('change', function() {
        const progress = getProgress();
        if (this.checked) {
          if (!progress.completed.includes(id)) {
            progress.completed.push(id);
          }
        } else {
          progress.completed = progress.completed.filter(x => x !== id);
        }
        saveProgress(progress);
        updateProgressBar();
      });
    });
  }

  // Clear all progress and go home
  window.clearProgress = function() {
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(LAST_PAGE_KEY);
    window.location.href = '/';
  };

  // Go to homepage (clears last page so you stay there)
  window.goHome = function(e) {
    if (e) e.preventDefault();
    localStorage.removeItem(LAST_PAGE_KEY);
    window.location.href = '/';
  };

  // Intercept Home link clicks in navbar
  function interceptHomeLink() {
    // Find navbar Home links (links to / or index.html with "Home" text)
    const navLinks = document.querySelectorAll('.navbar-nav a.nav-link, .navbar a');
    navLinks.forEach(link => {
      const href = link.getAttribute('href');
      const text = link.textContent.trim();
      if (text === 'Home' || href === '/' || href === '/index.html' || href === 'index.html') {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          goHome();
        });
      }
    });
  }

  // Run auto-resume immediately (before DOM loads for faster redirect)
  autoResume();

  // Run on page load
  document.addEventListener('DOMContentLoaded', function() {
    initCheckboxes();
    updateProgressBar();
    interceptHomeLink();
  });
})();
</script>
